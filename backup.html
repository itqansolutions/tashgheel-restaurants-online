<!DOCTYPE html>
<html lang="en" dir="ltr">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title data-i18n="backup">Backup - POS</title>
  <link rel="stylesheet" href="css/styles.css">
</head>

<body>
  <div class="language-switcher">
    <button class="lang-btn" data-lang="en">EN</button>
    <button class="lang-btn" data-lang="ar">AR</button>
  </div>

  <div class="app">
    <aside class="sidebar">
      <div class="sidebar-header">
        <h2>Restaurant POS</h2>
      </div>
      <nav><!-- Populated by shared-nav.js --></nav>
    </aside>

    <main class="main-content">
      <header class="top-bar">
        <h1 data-i18n="backup">Backup</h1>
      </header>

      <section class="content-area">

        <!-- Auto Backup Settings -->
        <div class="card mb-20" style="border-left: 5px solid #3498db;">
          <h2 data-i18n="auto_backup_settings">ğŸ”„ Automatic Daily Backup</h2>
          <p data-i18n="auto_backup_desc">Configure where to save your daily backups automatically.</p>

          <div style="margin: 15px 0;">
            <label style="display: flex; align-items: center; cursor: pointer;">
              <input type="checkbox" id="auto-backup-toggle" style="width: 20px; height: 20px; margin-right: 10px;">
              <span style="font-size: 1.1em;" data-i18n="enable_auto_backup">Enable Daily Automatic Backup</span>
            </label>
          </div>

          <div style="background: #f8f9fa; padding: 15px; border-radius: 8px; margin-top: 10px;">
            <strong data-i18n="backup_location">Backup Location:</strong><br>
            <code id="backup-folder-display"
              style="display: block; margin: 5px 0 10px 0; background: #eee; padding: 5px; border-radius: 4px;">No folder selected</code>
            <button id="select-folder-btn" class="btn btn-secondary" data-i18n="choose_folder_btn">ğŸ“‚ Choose
              Folder...</button>
          </div>
        </div>

        <div class="card">
          <h2 data-i18n="create_backup">ğŸ“¥ Create Backup</h2>
          <p data-i18n="create_backup_desc">Download a full backup of your current data.</p>
          <button onclick="createBackup()" class="btn btn-primary" data-i18n="create_backup_btn">ğŸ’¾ Download
            Backup</button>
        </div>

        <div class="card mt-20">
          <h2 data-i18n="restore_backup">ğŸ“¤ Restore Backup</h2>
          <p data-i18n="restore_backup_desc">Warning: Restoring will overwrite your current data!</p>
          <input type="file" id="backupFileInput" accept=".json">
          <button onclick="restoreBackup()" class="btn btn-danger mt-10" data-i18n="restore_backup_btn">âš ï¸ Restore
            Backup</button>
        </div>
      </section>
    </main>
  </div>

  <footer class="footer">
    Tashgheel POSÂ© 2025 - Designed and developed by <strong>itqan</strong> |
    <a href="tel:+201126522373">+201126522373 / +201155253886</a>
  </footer>


  <script src="js/web-adapter.js"></script>
  <script src="js/auth.js"></script>
  <script src="js/db.js"></script>
  <script>window.currentPage = 'backup';</script>
  <script src="js/shared-nav.js"></script>
  <script src="js/translations.js"></script>
  <script>
    window.currentPage = 'backup';

    // Keys to backup
    const DATA_KEYS = [
      'license', 'users', 'customers', 'vehicles', 'spare_parts', 'visits',
      'vendors', 'vendor_payments', 'sales', 'returns', 'expenses',
      'ingredients', 'tables', 'salesmen', 'delivery_areas'
    ];

    document.addEventListener('DOMContentLoaded', () => {
      const currentUser = JSON.parse(localStorage.getItem('currentUser'));
      if (currentUser?.role === 'cashier') {
        alert('Access denied');
        window.location.href = 'pos.html';
        return;
      }

      // Setup Auto Backup UI if electron
      if (window.electronAPI) {
        // Check saved settings if any (mock for now or implement simple storage)
        // For now, we focus on Manual Backup as requested.
      } else {
        // Hide Auto Backup section if not in Electron? 
        // Or keep it as "Not available in web mode"
      }
    });

    async function createBackup() {
      try {
        const data = {};

        if (window.electronAPI) {
          // Electron Mode: Read from files
          for (const key of DATA_KEYS) {
            const result = await window.electronAPI.readJson(key);
            if (result && result.value) {
              data['pos_secure_' + key] = result.value;
            }
          }
          // Also backup local storage items that are not data (settings)
          data['shopName'] = localStorage.getItem('shopName');
          data['shopAddress'] = localStorage.getItem('shopAddress');
          data['footerMessage'] = localStorage.getItem('footerMessage');
          data['shopLogo'] = localStorage.getItem('shopLogo');
          data['pos_language'] = localStorage.getItem('pos_language');

        } else {
          // Web Mode: Read from LocalStorage
          for (let key in localStorage) {
            if (localStorage.hasOwnProperty(key)) {
              data[key] = localStorage.getItem(key);
            }
          }
        }

        const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `pos_backup_${new Date().toISOString().split('T')[0]}.json`;
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        URL.revokeObjectURL(url);

      } catch (e) {
        console.error(e);
        alert('Error creating backup: ' + e.message);
      }
    }

    function restoreBackup() {
      if (!confirm('âš ï¸ This will overwrite your current data. Continue?')) return;
      const fileInput = document.getElementById('backupFileInput');
      const file = fileInput.files[0];
      if (!file) return alert('Please select a backup file.');

      const reader = new FileReader();
      reader.onload = async function (e) {
        try {
          const backupData = JSON.parse(e.target.result);
          if (!confirm('Are you sure you want to restore this backup? All current data will be lost.')) return;

          if (window.electronAPI) {
            // Electron Restore
            for (const key of DATA_KEYS) {
              const secureKey = 'pos_secure_' + key;
              if (backupData[secureKey]) {
                await window.electronAPI.writeJson(key, { value: backupData[secureKey] });
              } else {
                // If undefined, maybe clear it or leave it?
                // Safer to leave it or write empty? 
                // If full restore, we should probably overwrite.
              }
            }
            // Restore Settings
            ['shopName', 'shopAddress', 'footerMessage', 'shopLogo', 'pos_language'].forEach(k => {
              if (backupData[k]) localStorage.setItem(k, backupData[k]);
            });

          } else {
            // Web Restore
            localStorage.clear();
            for (let key in backupData) {
              localStorage.setItem(key, backupData[key]);
            }
          }

          alert('âœ… Backup restored successfully. The app will now reload.');
          location.reload();
        } catch (err) {
          console.error(err);
          alert('âŒ Failed to restore backup. Invalid file or permission error.');
        }
      };
      reader.readAsText(file);
    }
  </script>
</body>

</html>
