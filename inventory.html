<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Inventory - F&B POS</title>

    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>

    <!-- Fonts & Icons -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet"
        href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:opsz,wght,FILL,GRAD@20..48,100..700,0..1,-50..200" />

    <style>
        body {
            font-family: 'Inter', sans-serif;
        }

        ::-webkit-scrollbar {
            width: 6px;
            height: 6px;
        }

        ::-webkit-scrollbar-track {
            background: transparent;
        }

        ::-webkit-scrollbar-thumb {
            background: #cbd5e1;
            border-radius: 3px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: #94a3b8;
        }

        .modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            z-index: 50;
            display: none;
            align-items: center;
            justify-content: center;
        }

        .modal.active {
            display: flex;
        }

        .modal-content {
            background: white;
            border-radius: 0.75rem;
            box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
            max-height: 90vh;
            overflow-y: auto;
        }
    </style>
</head>

<body class="bg-slate-50 text-slate-800 h-screen overflow-hidden flex">

    <!-- Sidebar -->
    <aside id="sidebar"
        class="fixed inset-y-0 left-0 z-40 w-64 bg-[#1e293b] text-white flex flex-col shrink-0 transition-transform duration-300 transform -translate-x-full md:relative md:translate-x-0">
        <div class="p-6 border-b border-slate-700 flex justify-between items-center">
            <div class="flex items-center gap-3">
                <img src="favicon.png" alt="Logo" class="w-10 h-10 rounded-lg bg-white p-1 object-contain shadow-sm">
                <div>
                    <h2 class="font-bold text-sm leading-tight" id="posSystemTitle" data-i18n-key="shop_pos_system">F&B
                        POS System</h2>
                    <p class="text-[10px] text-slate-400" data-i18n-key="management_system">Management System</p>
                </div>
            </div>
            <!-- Mobile Close -->
            <button onclick="toggleSidebar()" class="md:hidden text-slate-400 hover:text-white">
                <span class="material-symbols-outlined">close</span>
            </button>
        </div>

        <!-- Navigation -->
        <nav class="flex-1 overflow-y-auto py-4 space-y-1" id="dynamic-nav">
            <!-- Populated by shared-nav.js -->
        </nav>
    </aside>

    <!-- Main Content Layout -->
    <div class="flex-1 flex flex-col min-w-0 overflow-hidden">

        <!-- Top Header -->
        <header class="h-16 bg-white border-b border-slate-200 flex items-center justify-between px-6 shrink-0 z-20">
            <div class="flex items-center gap-4">
                <!-- Mobile Toggle -->
                <button onclick="toggleSidebar()"
                    class="md:hidden p-2 -ml-2 text-slate-600 hover:bg-slate-100 rounded-lg">
                    <span class="material-symbols-outlined">menu</span>
                </button>
                <h1 class="text-xl font-bold text-slate-800 flex items-center gap-2">
                    <span class="material-symbols-outlined text-blue-600">inventory_2</span>
                    <span>Raw Materials & Stock</span>
                </h1>
            </div>

            <div class="flex items-center gap-4">
                <div class="flex bg-slate-100 rounded-lg p-1">
                    <button
                        class="lang-btn px-3 py-1 rounded-md text-xs font-semibold text-slate-600 hover:bg-white hover:shadow-sm transition-all active"
                        onclick="setLanguage('en')" id="langEn">EN</button>
                    <button
                        class="lang-btn px-3 py-1 rounded-md text-xs font-semibold text-slate-600 hover:bg-white hover:shadow-sm transition-all"
                        onclick="setLanguage('ar')" id="langAr">AR</button>
                </div>
            </div>
        </header>

        <!-- Content Scroller -->
        <main class="flex-1 overflow-y-auto p-6 scroll-smooth">
            <div class="max-w-7xl mx-auto space-y-6">

                <!-- Action Bar -->
                <div class="flex flex-wrap justify-between items-center gap-4">
                    <div class="flex items-center gap-4 flex-1">
                        <div class="relative flex-1 max-w-md">
                            <span class="material-symbols-outlined absolute left-3 top-2.5 text-slate-400">search</span>
                            <input type="text" id="searchBox" placeholder="Search materials..."
                                class="w-full pl-10 pr-4 py-2 bg-white border border-slate-200 rounded-lg focus:ring-2 focus:ring-blue-500 outline-none text-sm shadow-sm">
                        </div>
                    </div>
                    <button onclick="openStockAudit()"
                        class="flex items-center gap-2 bg-amber-500 hover:bg-amber-600 text-white px-5 py-2.5 rounded-xl font-medium shadow-sm transition-all active:scale-95">
                        <span class="material-symbols-outlined">checklist</span>
                        <span data-i18n-key="stock_audit_btn">Stock Audit</span>
                    </button>
                </div>

                <!-- Main Grid -->
                <div class="grid grid-cols-1 md:grid-cols-12 gap-6">

                    <!-- Materials List -->
                    <div class="md:col-span-8 lg:col-span-8 order-2 md:order-1">
                        <!-- Dashboard Container -->
                        <div id="inventory-dashboard"></div>

                        <div class="bg-white rounded-xl shadow-sm border border-slate-200 overflow-hidden">
                            <div class="px-6 py-4 border-b border-slate-100 bg-slate-50 font-bold text-slate-700">
                                Inventory List</div>
                            <div class="overflow-x-auto">
                                <table class="w-full text-left border-collapse">
                                    <thead
                                        class="bg-slate-50 text-xs font-semibold text-slate-500 uppercase tracking-wider border-b border-slate-100">
                                        <tr>
                                            <th class="px-6 py-3">Name</th>
                                            <th class="px-6 py-3">Unit</th>
                                            <th class="px-6 py-3 text-right">Cost/Unit</th>
                                            <th class="px-6 py-3 text-center">Stock</th>
                                            <th class="px-6 py-3 text-right">Total Value</th>
                                            <th class="px-6 py-3">Vendor</th>
                                            <th class="px-6 py-3 text-center">Actions</th>
                                        </tr>
                                    </thead>
                                    <tbody id="inventory-table-body" class="divide-y divide-slate-50 bg-white">
                                        <!-- Populated by JS -->
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>

                    <!-- Add Material Form -->
                    <div class="md:col-span-4 lg:col-span-4 order-1 md:order-2">
                        <div class="bg-white rounded-xl shadow-sm border border-slate-200 p-5 sticky top-6">
                            <h3 class="font-bold text-slate-800 mb-4 flex items-center gap-2 text-lg">
                                <span class="material-symbols-outlined text-green-600">add_circle</span>
                                <span>Add Material</span>
                            </h3>

                            <form id="inventory-form" class="space-y-4">
                                <input type="hidden" id="material-id">

                                <div>
                                    <label class="block text-xs font-bold text-slate-500 uppercase mb-1">Name</label>
                                    <input type="text" id="material-name" required placeholder="e.g. Tomato"
                                        class="w-full p-2 border border-slate-200 rounded-lg focus:ring-2 focus:ring-blue-500 outline-none">
                                </div>

                                <div>
                                    <label class="block text-xs font-bold text-slate-500 uppercase mb-1">Unit</label>
                                    <select id="material-unit" required
                                        class="w-full p-2 border border-slate-200 rounded-lg bg-white">
                                        <option value="kg">Kilogram (kg)</option>
                                        <option value="g">Gram (g)</option>
                                        <option value="l">Liter (l)</option>
                                        <option value="ml">Milliliter (ml)</option>
                                        <option value="pcs">Piece (pcs)</option>
                                    </select>
                                </div>

                                <div class="grid grid-cols-2 gap-4">
                                    <div>
                                        <label
                                            class="block text-xs font-bold text-slate-500 uppercase mb-1">Cost</label>
                                        <input type="number" id="material-cost" step="0.01" min="0" required
                                            class="w-full p-2 border border-slate-200 rounded-lg">
                                    </div>
                                    <div>
                                        <label
                                            class="block text-xs font-bold text-slate-500 uppercase mb-1">Stock</label>
                                        <input type="number" id="material-stock" step="0.001" min="0" required
                                            class="w-full p-2 border border-slate-200 rounded-lg">
                                    </div>
                                </div>

                                <div>
                                    <label class="block text-xs font-bold text-slate-500 uppercase mb-1">Vendor</label>
                                    <select id="material-vendor"
                                        class="w-full p-2 border border-slate-200 rounded-lg bg-white">
                                        <option value="">-- Select Vendor --</option>
                                    </select>
                                </div>

                                <div>
                                    <label class="block text-xs font-bold text-slate-500 uppercase mb-1">Expiration Date
                                        (Optional)</label>
                                    <input type="date" id="material-expiration"
                                        class="w-full p-2 border border-slate-200 rounded-lg focus:ring-2 focus:ring-blue-500 outline-none">
                                </div>

                                <div class="pt-2 flex gap-2">
                                    <button type="submit"
                                        class="flex-1 py-2 bg-blue-600 hover:bg-blue-700 text-white rounded-lg font-bold shadow-sm transition-colors">Save</button>
                                    <button type="button" onclick="resetForm()"
                                        class="px-3 py-2 bg-slate-100 hover:bg-slate-200 text-slate-600 rounded-lg font-medium transition-colors">Reset</button>
                                </div>
                            </form>
                        </div>
                    </div>

                </div>

            </div>
        </main>
    </div>

    <!-- Stock Audit Modal -->
    <div id="auditModal" class="modal">
        <!-- ... existing audit modal content ... -->
        <div class="modal-content w-full max-w-3xl p-6">
            <h3 class="text-xl font-bold text-slate-800 mb-4 flex items-center gap-2">
                <span class="material-symbols-outlined text-amber-500">checklist</span>
                Stock Audit
            </h3>
            <div class="max-h-[60vh] overflow-y-auto border border-slate-200 rounded-lg mb-4">
                <table class="w-full text-left text-sm">
                    <thead class="bg-slate-50 sticky top-0">
                        <tr>
                            <th class="p-3 border-b">Material</th>
                            <th class="p-3 border-b">Unit</th>
                            <th class="p-3 border-b text-center">Recorded</th>
                            <th class="p-3 border-b text-center">Actual</th>
                            <th class="p-3 border-b text-center">Diff</th>
                        </tr>
                    </thead>
                    <tbody id="auditTableBody" class="divide-y divide-slate-100 bg-white"></tbody>
                </table>
            </div>
            <div class="flex justify-end gap-3 pt-2 border-t border-slate-100">
                <button onclick="saveStockAudit()"
                    class="px-5 py-2 bg-green-500 hover:bg-green-600 text-white rounded-lg font-bold shadow-sm">Save
                    Changes</button>
                <button onclick="closeStockAudit()"
                    class="px-5 py-2 bg-slate-200 hover:bg-slate-300 text-slate-700 rounded-lg font-medium">Cancel</button>
            </div>
        </div>
    </div>

    <!-- ðŸŸ¢ NEW: Adjustment / Waste Modal -->
    <div id="adjustmentModal" class="modal">
        <div class="modal-content w-full max-w-md p-6">
            <h3 class="text-lg font-bold text-slate-800 mb-4 flex items-center gap-2">
                <span class="material-symbols-outlined text-amber-600">tune</span>
                Adjust / Waste Stock
            </h3>

            <div class="bg-amber-50 p-3 rounded-lg border border-amber-100 mb-4 text-sm text-amber-900">
                <input type="hidden" id="adj-id">
                <div class="flex justify-between">
                    <span>Current Stock: <strong id="adj-current-stock"></strong></span>
                    <span>Cost: <strong id="adj-current-cost"></strong></span>
                </div>
            </div>

            <div class="space-y-4">
                <div>
                    <label class="block text-xs font-bold text-slate-500 uppercase mb-1">Adjustment Type</label>
                    <select id="adj-type" class="w-full p-2 border border-slate-200 rounded-lg bg-white">
                        <option value="WASTE">Waste (Thrown away)</option>
                        <option value="DAMAGE">Damage (Broken/Spoiled)</option>
                        <option value="EXPIRED">Expired</option>
                        <option value="AUDIT">Audit Correction</option>
                        <option value="TRANSFER_IN">Transfer IN (+)</option>
                        <option value="TRANSFER_OUT">Transfer OUT (-)</option>
                    </select>
                </div>
                <div>
                    <label class="block text-xs font-bold text-slate-500 uppercase mb-1">Quantity</label>
                    <input type="number" id="adj-qty"
                        class="w-full p-2 border border-slate-200 rounded-lg focus:ring-2 focus:ring-amber-500"
                        placeholder="0.000" step="0.001">
                    <p class="text-[10px] text-slate-500 mt-1">For Waste/Damage, enter positive number (system will
                        subtract).</p>
                </div>
                <div>
                    <label class="block text-xs font-bold text-slate-500 uppercase mb-1">Reason</label>
                    <textarea id="adj-reason" rows="2"
                        class="w-full p-2 border border-slate-200 rounded-lg focus:ring-2 focus:ring-amber-500"
                        placeholder="Why is this matching happening?"></textarea>
                </div>
            </div>

            <div class="flex justify-end gap-3 mt-6 pt-4 border-t border-slate-100">
                <button onclick="confirmAdjustment()"
                    class="px-5 py-2 bg-amber-500 hover:bg-amber-600 text-white rounded-lg font-bold">Confirm</button>
                <button onclick="document.getElementById('adjustmentModal').style.display='none'"
                    class="px-5 py-2 bg-slate-200 hover:bg-slate-300 text-slate-700 rounded-lg">Cancel</button>
            </div>
        </div>
    </div>

    <!-- ðŸŸ¢ NEW: Transfer Modal -->
    <div id="transferModal" class="modal">
        <div class="modal-content w-full max-w-md p-6">
            <h3 class="text-lg font-bold text-slate-800 mb-4 flex items-center gap-2">
                <span class="material-symbols-outlined text-blue-600">move_up</span>
                Transfer Stock
            </h3>

            <div class="bg-blue-50 p-3 rounded-lg border border-blue-100 mb-4 text-sm text-blue-900">
                <input type="hidden" id="trf-id">
                <div class="flex justify-between">
                    <span>Available Stock: <strong id="trf-current-stock"></strong></span>
                </div>
            </div>

            <div class="space-y-4">
                <div>
                    <label class="block text-xs font-bold text-slate-500 uppercase mb-1">Target Branch</label>
                    <select id="trf-target-branch" class="w-full p-2 border border-slate-200 rounded-lg bg-white">
                        <option value="">Loading branches...</option>
                    </select>
                </div>
                <div>
                    <label class="block text-xs font-bold text-slate-500 uppercase mb-1">Quantity</label>
                    <input type="number" id="trf-qty"
                        class="w-full p-2 border border-slate-200 rounded-lg focus:ring-2 focus:ring-blue-500"
                        placeholder="0.000" step="0.001">
                </div>
            </div>

            <div class="flex justify-end gap-3 mt-6 pt-4 border-t border-slate-100">
                <button onclick="confirmTransfer()"
                    class="px-5 py-2 bg-blue-600 hover:bg-blue-700 text-white rounded-lg font-bold">Transfer</button>
                <button onclick="document.getElementById('transferModal').style.display='none'"
                    class="px-5 py-2 bg-slate-200 hover:bg-slate-300 text-slate-700 rounded-lg">Cancel</button>
            </div>
        </div>
    </div>

    <!-- Restock Modal -->
    <div id="restockModal" class="modal">
        <div class="modal-content w-full max-w-md p-6">
            <h3 class="text-lg font-bold text-slate-800 mb-4 flex items-center gap-2">
                <span class="material-symbols-outlined text-green-600">add_box</span>
                Restock Material
            </h3>

            <div class="bg-indigo-50 p-3 rounded-lg border border-indigo-100 mb-4 text-sm text-indigo-900">
                <input type="hidden" id="restock-id">
                <div class="flex justify-between">
                    <span>Current Stock: <strong id="restock-current-stock"></strong></span>
                    <span>Avg Cost: <strong id="restock-current-cost"></strong></span>
                </div>
            </div>

            <div class="space-y-4">
                <div>
                    <label class="block text-xs font-bold text-slate-500 uppercase mb-1">Add Qty</label>
                    <input type="number" id="restock-qty"
                        class="w-full p-2 border border-slate-200 rounded-lg focus:ring-2 focus:ring-green-500"
                        placeholder="0.000" step="0.001">
                </div>
                <div>
                    <label class="block text-xs font-bold text-slate-500 uppercase mb-1">New Unit Cost</label>
                    <input type="number" id="restock-cost"
                        class="w-full p-2 border border-slate-200 rounded-lg focus:ring-2 focus:ring-green-500"
                        step="0.01">
                </div>
                <div>
                    <label class="block text-xs font-bold text-slate-500 uppercase mb-1">Payment</label>
                    <select id="restock-method" class="w-full p-2 border border-slate-200 rounded-lg bg-white">
                        <option value="credit">Credit (Pay Later)</option>
                        <option value="cash">Cash (Paid Now)</option>
                    </select>
                </div>
            </div>

            <div class="flex justify-end gap-3 mt-6 pt-4 border-t border-slate-100">
                <button onclick="confirmRestock()"
                    class="px-5 py-2 bg-green-500 hover:bg-green-600 text-white rounded-lg font-bold">Confirm</button>
                <button onclick="document.getElementById('restockModal').style.display='none'"
                    class="px-5 py-2 bg-slate-200 hover:bg-slate-300 text-slate-700 rounded-lg">Cancel</button>
            </div>
        </div>
    </div>

    <script src="js/web-adapter.js"></script>
    <script src="js/auth.js"></script>
    <script src="js/db.js"></script>
    <script>window.currentPage = 'inventory';</script>
    <script src="js/shared-nav.js"></script>
    <script src="js/translations.js"></script>
    <script src="js/inventory-app.js"></script>

    <!-- Modal Helpers -->
    <script>
        function closeModal(id) { document.getElementById(id).classList.remove('active'); document.getElementById(id).style.display = 'none'; }
        // Overriding globals to ensure display:flex is set for Tailwind modal
        const _oldOpenAudit = window.openStockAudit;
        window.openStockAudit = function () {
            // Logic handled in app.js, we just ensure class 'active' is added if we hook it, 
            // OR we can rely on app.js setting display:block and we add a CSS rule [style*="block"] { display: flex !important } ? 
            // Better: override the open functions here if possible, but they are defined in app.js
            // Since app.js defines `document.getElementById('auditModal').style.display = 'block'`,
            // I added `.modal[style*="block"] { display: flex !important; }` hack or just redefine the open function.
            // Let's redefine close.

            // Actually, easiest way is to let app.js do `display = 'block'` and I change my CSS to allow block but use flex inside?
            // Or I monkey patch the open function.
            // Since app.js is loaded AFTER this, it will overwrite my overrides here if I put them in body.
            // So I will fix it by patching app.js or handling it in CSS.
        }
    </script>
    <style>
        /* Compatibility for JS setting display:block */
        .modal[style*="display: block"] {
            display: flex !important;
        }
    </style>
</body>

</html>