<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title data-i18n-key="page_title" data-i18n-ar="التقارير">Reports - Tashgheel POS</title>

  <!-- Tailwind CSS -->
  <script src="https://cdn.tailwindcss.com?plugins=forms,typography,aspect-ratio"></script>

  <!-- Fonts & Icons -->
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
  <link rel="stylesheet"
    href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:opsz,wght,FILL,GRAD@20..48,100..700,0..1,-50..200" />

  <!-- Libraries -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.25/jspdf.plugin.autotable.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

  <style>
    body {
      font-family: 'Inter', sans-serif;
    }

    .report-tab.active {
      background-color: #eff6ff;
      color: #2563eb;
      border-bottom: 2px solid #2563eb;
    }
  </style>
</head>

<body class="bg-slate-50 text-slate-800 h-screen flex overflow-hidden">

  <!-- Sidebar (Standardized) -->
  <aside id="sidebar"
    class="fixed inset-y-0 left-0 z-40 w-64 bg-slate-900 text-white flex flex-col shrink-0 transition-transform duration-300 transform -translate-x-full md:relative md:translate-x-0">
    <div class="h-16 flex items-center justify-between px-6 border-b border-slate-800">
      <h2 class="text-xl font-bold tracking-tight">Tashgheel POS</h2>
      <!-- Mobile Close -->
      <button onclick="toggleSidebar()" class="md:hidden text-slate-400 hover:text-white">
        <span class="material-symbols-outlined">close</span>
      </button>
    </div>
    <nav class="flex-1 overflow-y-auto py-4 px-3 space-y-1">
      <!-- Populated by shared-nav.js -->
    </nav>

  </aside>

  <!-- Main Content -->
  <div class="flex-1 flex flex-col min-w-0">

    <!-- Top Bar -->
    <header class="h-16 bg-white border-b border-slate-200 flex items-center justify-between px-4 sm:px-8 z-10">
      <div class="flex items-center gap-4">
        <button onclick="toggleSidebar()" class="md:hidden p-2 text-slate-500 hover:bg-slate-100 rounded-lg">
          <span class="material-symbols-outlined">menu</span>
        </button>
        <h1 class="text-xl font-bold text-slate-800 flex items-center gap-2">
          <span class="material-symbols-outlined text-blue-600">analytics</span>
          <span data-i18n-key="reports" data-i18n-ar="التقارير">Reports Analytics</span>
        </h1>
      </div>

      <div class="flex items-center gap-3">
        <div class="language-switcher flex bg-slate-100 p-1 rounded-lg">
          <button class="lang-btn px-3 py-1 text-xs font-bold rounded-md transition-colors" data-lang="en">EN</button>
          <button class="lang-btn px-3 py-1 text-xs font-bold rounded-md transition-colors" data-lang="ar">AR</button>
        </div>
      </div>
    </header>

    <main class="flex-1 overflow-y-auto p-4 sm:p-8">
      <div class="max-w-7xl mx-auto space-y-6">

        <!-- Controls & Filters -->
        <div class="bg-white rounded-xl shadow-sm border border-slate-200 p-5">
          <div class="flex flex-col gap-6">

            <!-- Navigation Tabs -->
            <div class="w-full overflow-x-auto pb-2 -mb-2">
              <div class="flex gap-6 border-b border-slate-200 min-w-max" id="report-tabs">
                <button
                  class="report-tab active pb-3 px-1 text-sm font-semibold text-slate-500 hover:text-blue-600 transition-colors flex items-center gap-2"
                  data-tab="live">
                  <span class="material-symbols-outlined text-[18px]">radio_button_checked</span> Live Monitor
                </button>
                <button
                  class="report-tab pb-3 px-1 text-sm font-semibold text-slate-500 hover:text-blue-600 transition-colors flex items-center gap-2"
                  data-tab="sales">
                  <span class="material-symbols-outlined text-[18px]">payments</span> Sales
                </button>
                <button
                  class="report-tab pb-3 px-1 text-sm font-semibold text-slate-500 hover:text-blue-600 transition-colors flex items-center gap-2"
                  data-tab="delivery">
                  <span class="material-symbols-outlined text-[18px]">two_wheeler</span> Delivery
                </button>
                <button
                  class="report-tab pb-3 px-1 text-sm font-semibold text-slate-500 hover:text-blue-600 transition-colors flex items-center gap-2 admin-only"
                  data-tab="cogs">
                  <span class="material-symbols-outlined text-[18px]">inventory_2</span> COGS
                </button>
                <button
                  class="report-tab pb-3 px-1 text-sm font-semibold text-slate-500 hover:text-blue-600 transition-colors flex items-center gap-2"
                  data-tab="expenses">
                  <span class="material-symbols-outlined text-[18px]">account_balance_wallet</span> Expenses
                </button>
                <button
                  class="report-tab pb-3 px-1 text-sm font-semibold text-slate-500 hover:text-blue-600 transition-colors flex items-center gap-2 admin-only"
                  data-tab="inventory-report">
                  <span class="material-symbols-outlined text-[18px]">attach_money</span> Stock Value
                </button>
              </div>
            </div>

            <!-- Filters Container -->
            <div class="flex flex-col xl:flex-row gap-6 justify-between items-end border-b border-slate-200 pb-6">

              <!-- 1. Branch & Presets -->
              <div class="flex flex-col gap-4 w-full xl:w-auto">
                <div class="flex flex-wrap gap-3 items-center">
                  <!-- Branch Filter -->
                  <div class="w-full sm:w-64">
                    <label class="block text-xs font-bold text-slate-500 uppercase mb-1">Branch</label>
                    <select id="branchFilter"
                      class="w-full text-sm border-slate-200 rounded-lg focus:ring-blue-500 py-2">
                      <option value="all">Please Wait...</option>
                    </select>
                  </div>

                  <!-- ACTION BAR -->
                  <div class="flex items-center gap-3">
                    <!-- Unified Action Buttons -->
                    <button onclick="window.ReportExport.exportToExcel(getCurrentTab())"
                      class="bg-white border border-slate-200 text-slate-600 hover:bg-slate-50 px-3 py-1.5 rounded-lg text-sm font-semibold flex items-center gap-2 transition-colors shadow-sm">
                      <span class="material-symbols-outlined text-[18px] text-green-600">table_view</span> Excel
                    </button>
                    <button onclick="window.ReportExport.exportToPDF(getCurrentTab())"
                      class="bg-white border border-slate-200 text-slate-600 hover:bg-slate-50 px-3 py-1.5 rounded-lg text-sm font-semibold flex items-center gap-2 transition-colors shadow-sm">
                      <span class="material-symbols-outlined text-[18px] text-red-500">picture_as_pdf</span> PDF
                    </button>
                    <button onclick="window.ReportExport.printCurrentView(getCurrentTab())"
                      class="bg-white border border-slate-200 text-slate-600 hover:bg-slate-50 px-3 py-1.5 rounded-lg text-sm font-semibold flex items-center gap-2 transition-colors shadow-sm">
                      <span class="material-symbols-outlined text-[18px]">print</span> Print
                    </button>

                    <button onclick="refreshReports()"
                      class="bg-blue-600 hover:bg-blue-700 text-white px-3 py-1.5 rounded-lg text-sm font-semibold flex items-center gap-2 transition-colors shadow-sm group">
                      <span
                        class="material-symbols-outlined text-[18px] group-hover:rotate-180 transition-transform duration-500">refresh</span>
                      <span class="hidden sm:inline">Refresh Data</span>
                    </button>
                  </div>
                </div>

                <!-- Date Presets -->
                <div class="flex flex-wrap gap-2">
                  <button onclick="setDateRange('today')"
                    class="px-3 py-1.5 bg-slate-100 hover:bg-slate-200 text-slate-600 text-xs font-bold rounded-lg transition-colors">Today</button>
                  <button onclick="setDateRange('yesterday')"
                    class="px-3 py-1.5 bg-slate-100 hover:bg-slate-200 text-slate-600 text-xs font-bold rounded-lg transition-colors">Yesterday</button>
                  <button onclick="setDateRange('thisWeek')"
                    class="px-3 py-1.5 bg-slate-100 hover:bg-slate-200 text-slate-600 text-xs font-bold rounded-lg transition-colors">This
                    Week</button>
                  <button onclick="setDateRange('thisMonth')"
                    class="px-3 py-1.5 bg-slate-100 hover:bg-slate-200 text-slate-600 text-xs font-bold rounded-lg transition-colors">This
                    Month</button>
                  <button onclick="setDateRange('lastMonth')"
                    class="px-3 py-1.5 bg-slate-100 hover:bg-slate-200 text-slate-600 text-xs font-bold rounded-lg transition-colors">Last
                    Month</button>
                </div>
              </div>

              <!-- 2. Date Pickers -->
              <input type="hidden" id="datePreset" value="today">
              <div
                class="flex items-center gap-3 w-full md:w-auto flex-shrink-0 bg-slate-50 p-3 rounded-xl border border-slate-200">
                <div class="flex-1 md:w-36">
                  <label class="block text-[10px] font-bold text-slate-400 uppercase mb-1">From Date</label>
                  <input type="date" id="startDate" onchange="handleCustomDateChange()"
                    class="w-full text-xs font-semibold border-slate-200 rounded-lg focus:ring-blue-500">
                </div>
                <span class="text-slate-300 mt-4">➜</span>
                <div class="flex-1 md:w-36">
                  <label class="block text-[10px] font-bold text-slate-400 uppercase mb-1">To Date</label>
                  <input type="date" id="endDate" onchange="handleCustomDateChange()"
                    class="w-full text-xs font-semibold border-slate-200 rounded-lg focus:ring-blue-500">
                </div>
              </div>

            </div>

            <!-- === CONTENT AREAS === -->

            <!-- 1. LIVE MONITOR -->
            <div id="card-live" class="report-card space-y-6">

              <!-- Row 1: KPI Cards -->
              <div class="grid grid-cols-2 md:grid-cols-3 xl:grid-cols-6 gap-4">
                <!-- Net Sales -->
                <div class="bg-white p-4 rounded-xl shadow-sm border border-slate-200">
                  <div class="text-xs font-bold text-slate-500 uppercase mb-1">Net Sales</div>
                  <div class="text-xl font-bold text-slate-800" id="live-net-sales">0.00</div>
                  <div class="text-[10px] text-green-600 font-semibold mt-1">Real-time</div>
                </div>
                <!-- Orders -->
                <div class="bg-white p-4 rounded-xl shadow-sm border border-slate-200">
                  <div class="text-xs font-bold text-slate-500 uppercase mb-1">Orders</div>
                  <div class="text-xl font-bold text-slate-800" id="live-orders-count">0</div>
                  <div class="text-[10px] text-slate-400 font-semibold mt-1">Receipts</div>
                </div>
                <!-- Avg Ticket -->
                <div class="bg-white p-4 rounded-xl shadow-sm border border-slate-200">
                  <div class="text-xs font-bold text-slate-500 uppercase mb-1">Avg Ticket</div>
                  <div class="text-xl font-bold text-slate-800" id="live-avg-ticket">0.00</div>
                  <div class="text-[10px] text-slate-400 font-semibold mt-1">Per Order</div>
                </div>
                <!-- Gross Profit -->
                <div class="bg-white p-4 rounded-xl shadow-sm border border-slate-200">
                  <div class="text-xs font-bold text-slate-500 uppercase mb-1">Gross Profit</div>
                  <div class="text-xl font-bold text-emerald-700" id="live-gross-profit">0.00</div>
                  <div class="text-[10px] text-emerald-600 font-semibold mt-1">Sales - COGS</div>
                </div>
                <!-- Discounts -->
                <div class="bg-white p-4 rounded-xl shadow-sm border border-slate-200">
                  <div class="text-xs font-bold text-slate-500 uppercase mb-1">Discounts</div>
                  <div class="text-xl font-bold text-red-600" id="live-discounts">0.00</div>
                  <div class="text-[10px] text-red-400 font-semibold mt-1">Deductions</div>
                </div>
                <!-- Returns -->
                <div class="bg-white p-4 rounded-xl shadow-sm border border-slate-200">
                  <div class="text-xs font-bold text-slate-500 uppercase mb-1">Returns</div>
                  <div class="text-xl font-bold text-red-600" id="live-returns">0.00</div>
                  <div class="text-[10px] text-red-400 font-semibold mt-1">Refunded</div>
                </div>
              </div>

              <!-- Row 2: Charts -->
              <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                <!-- Sales Per Hour -->
                <div class="lg:col-span-2 bg-white p-5 rounded-xl shadow-sm border border-slate-200">
                  <h3 class="font-bold text-slate-800 mb-4 flex items-center gap-2">
                    <span class="material-symbols-outlined text-blue-600">trending_up</span> Sales Per Hour
                  </h3>
                  <div class="h-64 relative">
                    <canvas id="chart-sales-hour"></canvas>
                  </div>
                </div>
                <!-- Payment Distribution -->
                <div class="bg-white p-5 rounded-xl shadow-sm border border-slate-200">
                  <h3 class="font-bold text-slate-800 mb-4 flex items-center gap-2">
                    <span class="material-symbols-outlined text-purple-600">pie_chart</span> Payment Method
                  </h3>
                  <div class="h-64 relative flex items-center justify-center">
                    <canvas id="chart-payment-method"></canvas>
                  </div>
                </div>
              </div>

              <!-- Row 3: Shift Bar -->
              <div id="live-shift-bar"
                class="hidden bg-amber-50 border border-amber-200 rounded-lg p-3 flex flex-wrap justify-between items-center text-sm">
                <div class="flex items-center gap-2 text-amber-900">
                  <span class="material-symbols-outlined text-amber-600">lock_clock</span>
                  <span class="font-bold">Active Shift:</span> <span id="shift-start-time">--:--</span>
                </div>
                <div class="flex items-center gap-2 text-amber-900">
                  <span class="font-bold">Drawer Expected:</span> <span id="shift-expected-drawer"
                    class="font-mono font-bold text-lg">0.00</span>
                </div>
              </div>

              <!-- Row 4: Recent Activity Table -->
              <div class="bg-white rounded-xl shadow-sm border border-slate-200 overflow-hidden">
                <div class="px-6 py-4 border-b border-slate-100 font-bold text-slate-800 flex items-center gap-2">
                  <span class="material-symbols-outlined text-slate-400">schedule</span> Recent Orders
                </div>
                <div class="overflow-x-auto">
                  <table id="table-recent-orders" class="w-full text-left border-collapse">
                    <thead class="bg-slate-50 text-xs font-semibold text-slate-500 uppercase border-b border-slate-200">
                      <tr>
                        <th class="px-6 py-3">Order ID</th>
                        <th class="px-6 py-3">Branch</th>
                        <th class="px-6 py-3">Amount</th>
                        <th class="px-6 py-3">Method</th>
                        <th class="px-6 py-3">Cashier</th>
                        <th class="px-6 py-3">Status</th>
                        <th class="px-6 py-3">Time</th>
                      </tr>
                    </thead>
                    <tbody id="live-recent-body" class="divide-y divide-slate-100 text-sm text-slate-600">
                      <!-- Populated JS -->
                    </tbody>
                  </table>
                </div>
              </div>
            </div>

            <!-- 2. TOTAL SALES REPORT -->
            <div id="card-sales" class="report-card hidden space-y-6">

              <!-- Row 1: Summary Cards -->
              <div class="grid grid-cols-2 md:grid-cols-5 gap-4">
                <div class="bg-white p-4 rounded-xl shadow-sm border border-slate-200">
                  <div class="text-xs font-bold text-slate-500 uppercase mb-1">Gross Sales</div>
                  <div class="text-xl font-bold text-slate-800" id="sales-gross">0.00</div>
                  <div class="text-[10px] text-slate-400 font-semibold mt-1">Pre-Discount</div>
                </div>
                <div class="bg-white p-4 rounded-xl shadow-sm border border-slate-200">
                  <div class="text-xs font-bold text-slate-500 uppercase mb-1">Net Sales</div>
                  <div class="text-xl font-bold text-emerald-700" id="sales-net">0.00</div>
                  <div class="text-[10px] text-emerald-600 font-semibold mt-1">Real Revenue</div>
                </div>
                <div class="bg-white p-4 rounded-xl shadow-sm border border-slate-200">
                  <div class="text-xs font-bold text-slate-500 uppercase mb-1">Tax Collected</div>
                  <div class="text-xl font-bold text-slate-800" id="sales-tax">0.00</div>
                  <div class="text-[10px] text-slate-400 font-semibold mt-1">VAT / Taxes</div>
                </div>
                <div class="bg-white p-4 rounded-xl shadow-sm border border-slate-200">
                  <div class="text-xs font-bold text-slate-500 uppercase mb-1">Orders Count</div>
                  <div class="text-xl font-bold text-slate-800" id="sales-orders">0</div>
                  <div class="text-[10px] text-slate-400 font-semibold mt-1">Completed</div>
                </div>
                <div class="bg-white p-4 rounded-xl shadow-sm border border-slate-200">
                  <div class="text-xs font-bold text-slate-500 uppercase mb-1">Avg Ticket</div>
                  <div class="text-xl font-bold text-slate-800" id="sales-avg">0.00</div>
                  <div class="text-[10px] text-slate-400 font-semibold mt-1">Net / Orders</div>
                </div>
              </div>

              <!-- Row 2: Charts -->
              <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                <!-- Payment Method Pie -->
                <div class="bg-white p-5 rounded-xl shadow-sm border border-slate-200">
                  <h3 class="font-bold text-slate-800 mb-4 flex items-center gap-2">
                    <span class="material-symbols-outlined text-purple-600">pie_chart</span> Sales by Payment
                  </h3>
                  <div class="h-64 relative flex items-center justify-center">
                    <canvas id="chart-sales-payment"></canvas>
                  </div>
                </div>
                <!-- Category Bar -->
                <div class="bg-white p-5 rounded-xl shadow-sm border border-slate-200">
                  <h3 class="font-bold text-slate-800 mb-4 flex items-center gap-2">
                    <span class="material-symbols-outlined text-blue-600">bar_chart</span> Sales by Category
                  </h3>
                  <div class="h-64 relative">
                    <canvas id="chart-sales-category"></canvas>
                  </div>
                </div>
              </div>

              <!-- Row 3: Tables Grid -->
              <div class="grid grid-cols-1 xl:grid-cols-2 gap-6">

                <!-- Category Performance -->
                <div class="bg-white rounded-xl shadow-sm border border-slate-200 overflow-hidden">
                  <div class="px-6 py-4 border-b border-slate-100 font-bold text-slate-800 flex items-center gap-2">
                    <span class="material-symbols-outlined text-slate-400">category</span> Category Performance
                  </div>
                  <div class="overflow-x-auto max-h-80">
                    <table id="table-category-perf" class="w-full text-left border-collapse">
                      <thead
                        class="bg-slate-50 text-xs font-semibold text-slate-500 uppercase border-b border-slate-200 sticky top-0">
                        <tr>
                          <th class="px-4 py-2">Category</th>
                          <th class="px-4 py-2">Qty</th>
                          <th class="px-4 py-2">Net Sales</th>
                          <th class="px-4 py-2">%</th>
                        </tr>
                      </thead>
                      <tbody id="table-sales-category" class="divide-y divide-slate-100 text-sm text-slate-600"></tbody>
                    </table>
                  </div>
                </div>

                <!-- Cashier Performance -->
                <div class="bg-white rounded-xl shadow-sm border border-slate-200 overflow-hidden">
                  <div class="px-6 py-4 border-b border-slate-100 font-bold text-slate-800 flex items-center gap-2">
                    <span class="material-symbols-outlined text-slate-400">person</span> Cashier Performance
                  </div>
                  <div class="overflow-x-auto max-h-80">
                    <table class="w-full text-left border-collapse">
                      <thead
                        class="bg-slate-50 text-xs font-semibold text-slate-500 uppercase border-b border-slate-200 sticky top-0">
                        <tr>
                          <th class="px-4 py-2">Cashier</th>
                          <th class="px-4 py-2">Orders</th>
                          <th class="px-4 py-2">Net Sales</th>
                          <th class="px-4 py-2">Avg</th>
                        </tr>
                      </thead>
                      <tbody id="table-sales-cashier" class="divide-y divide-slate-100 text-sm text-slate-600"></tbody>
                    </table>
                  </div>
                </div>

                <!-- Top Products (Full Width) -->
                <div class="xl:col-span-2 bg-white rounded-xl shadow-sm border border-slate-200 overflow-hidden">
                  <div class="px-6 py-4 border-b border-slate-100 font-bold text-slate-800 flex items-center gap-2">
                    <span class="material-symbols-outlined text-slate-400">star</span> Top Products
                  </div>
                  <div class="overflow-x-auto max-h-80">
                    <table class="w-full text-left border-collapse">
                      <thead
                        class="bg-slate-50 text-xs font-semibold text-slate-500 uppercase border-b border-slate-200 sticky top-0">
                        <tr>
                          <th class="px-6 py-3">Product Name</th>
                          <th class="px-6 py-3">Qty Sold</th>
                          <th class="px-6 py-3">Gross Sales</th>
                          <th class="px-6 py-3">Net Sales</th>
                        </tr>
                      </thead>
                      <tbody id="table-sales-products" class="divide-y divide-slate-100 text-sm text-slate-600"></tbody>
                    </table>
                  </div>
                </div>

              </div>
            </div>

            <!-- 3. DELIVERY REPORT (NEW) -->
            <div id="card-delivery" class="report-card hidden space-y-6">

              <!-- Row 1: KPI Cards -->
              <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
                <div class="bg-white p-4 rounded-xl shadow-sm border border-slate-200">
                  <div class="text-xs font-bold text-slate-500 uppercase mb-1">Total Delivery Revenue</div>
                  <div class="text-xl font-bold text-slate-800" id="del-total-revenue">0.00</div>
                  <div class="text-[10px] text-slate-400 font-semibold mt-1">Sales + Fees</div>
                </div>
                <div class="bg-white p-4 rounded-xl shadow-sm border border-slate-200">
                  <div class="text-xs font-bold text-slate-500 uppercase mb-1">Delivery Fees</div>
                  <div class="text-xl font-bold text-purple-600" id="del-total-fees">0.00</div>
                  <div class="text-[10px] text-purple-400 font-semibold mt-1">Fees Collected</div>
                </div>
                <div class="bg-white p-4 rounded-xl shadow-sm border border-slate-200">
                  <div class="text-xs font-bold text-slate-500 uppercase mb-1">Total Orders</div>
                  <div class="text-xl font-bold text-slate-800" id="del-total-orders">0</div>
                  <div class="text-[10px] text-slate-400 font-semibold mt-1">Completed Deliveries</div>
                </div>
                <div class="bg-white p-4 rounded-xl shadow-sm border border-slate-200">
                  <div class="text-xs font-bold text-slate-500 uppercase mb-1">Avg Delivery Fee</div>
                  <div class="text-xl font-bold text-slate-800" id="del-avg-fee">0.00</div>
                  <div class="text-[10px] text-slate-400 font-semibold mt-1">Per Order</div>
                </div>
              </div>

              <!-- Row 2: Charts -->
              <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                <!-- Fees Trend -->
                <div class="lg:col-span-2 bg-white p-5 rounded-xl shadow-sm border border-slate-200">
                  <h3 class="font-bold text-slate-800 mb-4 flex items-center gap-2">
                    <span class="material-symbols-outlined text-purple-600">trending_up</span> Daily Delivery Fees
                  </h3>
                  <div class="h-64 relative">
                    <canvas id="chart-delivery-trend"></canvas>
                  </div>
                </div>
                <!-- Sources -->
                <div class="bg-white p-5 rounded-xl shadow-sm border border-slate-200">
                  <h3 class="font-bold text-slate-800 mb-4 flex items-center gap-2">
                    <span class="material-symbols-outlined text-orange-500">pie_chart</span> Orders by Source
                  </h3>
                  <div class="h-64 relative flex items-center justify-center">
                    <canvas id="chart-delivery-sources"></canvas>
                  </div>
                </div>
              </div>

              <!-- Row 3: Tables -->
              <div class="grid grid-cols-1 xl:grid-cols-2 gap-6">

                <!-- Driver Performance -->
                <div class="bg-white rounded-xl shadow-sm border border-slate-200 overflow-hidden">
                  <div class="px-6 py-4 border-b border-slate-100 font-bold text-slate-800 flex items-center gap-2">
                    <span class="material-symbols-outlined text-slate-400">sports_motorsports</span> Delivery Man
                    Performance (Internal)
                  </div>
                  <div class="overflow-x-auto max-h-80">
                    <table id="table-delivery-export" class="w-full text-left border-collapse">
                      <thead
                        class="bg-slate-50 text-xs font-semibold text-slate-500 uppercase border-b border-slate-200 sticky top-0">
                        <tr>
                          <th class="px-4 py-2">Driver</th>
                          <th class="px-4 py-2">Orders</th>
                          <th class="px-4 py-2">Fees Generated</th>
                          <th class="px-4 py-2">Total Sales</th>
                        </tr>
                      </thead>
                      <tbody id="table-delivery-drivers" class="divide-y divide-slate-100 text-sm text-slate-600">
                      </tbody>
                    </table>
                  </div>
                </div>

                <!-- Source Performance -->
                <div class="bg-white rounded-xl shadow-sm border border-slate-200 overflow-hidden">
                  <div class="px-6 py-4 border-b border-slate-100 font-bold text-slate-800 flex items-center gap-2">
                    <span class="material-symbols-outlined text-slate-400">hub</span> Source Performance
                  </div>
                  <div class="overflow-x-auto max-h-80">
                    <table class="w-full text-left border-collapse">
                      <thead
                        class="bg-slate-50 text-xs font-semibold text-slate-500 uppercase border-b border-slate-200 sticky top-0">
                        <tr>
                          <th class="px-4 py-2">Source</th>
                          <th class="px-4 py-2">Orders</th>
                          <th class="px-4 py-2">Revenue</th>
                        </tr>
                      </thead>
                      <tbody id="table-delivery-sources" class="divide-y divide-slate-100 text-sm text-slate-600">
                      </tbody>
                    </table>
                  </div>
                </div>

              </div>
            </div>

            <!-- 3. VISITS REPORT -->


            <!-- 4. EXPENSES REPORT -->
            <!-- 4. EXPENSES REPORT -->
            <div id="card-expenses" class="report-card hidden space-y-6">
              <!-- KPI Grid -->
              <div class="grid grid-cols-1 md:grid-cols-4 gap-6">
                <!-- Total Expenses -->
                <div class="bg-white p-6 rounded-xl shadow-sm border border-slate-200">
                  <p class="text-sm text-slate-500 mb-1">Total Expenses</p>
                  <h3 class="text-2xl font-bold text-red-600" id="expenses-total">0.00</h3>
                </div>
                <!-- Daily Average -->
                <div class="bg-white p-6 rounded-xl shadow-sm border border-slate-200">
                  <p class="text-sm text-slate-500 mb-1">Daily Average</p>
                  <h3 class="text-2xl font-bold text-slate-800" id="expenses-daily-avg">0.00</h3>
                </div>
                <!-- Largest Expense -->
                <div class="bg-white p-6 rounded-xl shadow-sm border border-slate-200">
                  <p class="text-sm text-slate-500 mb-1">Largest Expense</p>
                  <h3 class="text-2xl font-bold text-slate-800" id="expenses-largest">0.00</h3>
                  <p class="text-xs text-slate-400 mt-1 truncate" id="expenses-largest-name">-</p>
                </div>
                <!-- Net Profit (After Expenses) -->
                <div class="bg-white p-6 rounded-xl shadow-sm border border-slate-200">
                  <p class="text-sm text-slate-500 mb-1">Net Profit</p>
                  <h3 class="text-2xl font-bold text-green-600" id="expenses-net-profit">0.00</h3>
                </div>
              </div>

              <!-- Charts Row -->
              <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                <!-- Expense Category Chart -->
                <div class="bg-white p-6 rounded-xl shadow-sm border border-slate-200">
                  <h3 class="font-bold text-lg text-slate-800 mb-4">Expenses by Category</h3>
                  <div class="h-64">
                    <canvas id="chart-expenses-category"></canvas>
                  </div>
                </div>
                <!-- Expense Trend Chart -->
                <div class="bg-white p-6 rounded-xl shadow-sm border border-slate-200">
                  <h3 class="font-bold text-lg text-slate-800 mb-4">Daily Expense Trend</h3>
                  <div class="h-64">
                    <canvas id="chart-expenses-trend"></canvas>
                  </div>
                </div>
              </div>

              <!-- Detailed Table -->
              <div class="bg-white p-6 rounded-xl shadow-sm border border-slate-200">
                <div class="flex justify-between items-center mb-4">
                  <h3 class="font-bold text-lg text-slate-800">Expense Details</h3>
                  <button onclick="window.exportReportToExcel('expenses')"
                    class="text-sm text-blue-600 hover:text-blue-800 font-medium">
                    Export to Excel
                  </button>
                </div>
                <div class="overflow-x-auto">
                  <table id="table-expenses-export" class="w-full text-left text-sm text-slate-600">
                    <thead class="bg-slate-50 text-xs uppercase font-semibold text-slate-500">
                      <tr>
                        <th class="px-4 py-3">Date</th>
                        <th class="px-4 py-3">Category</th>
                        <th class="px-4 py-3">Description</th>
                        <th class="px-4 py-3 text-right">Amount</th>
                      </tr>
                    </thead>
                    <tbody id="table-expenses" class="divide-y divide-slate-100">
                      <!-- Populated by JS -->
                    </tbody>
                  </table>
                </div>
              </div>
            </div>

            <!-- 5. COGS & PROFIT (Admin) -->
            <div id="card-cogs" class="report-card admin-only hidden space-y-6">

              <!-- Row 1: Summary Cards -->
              <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
                <div class="bg-white p-4 rounded-xl shadow-sm border border-slate-200">
                  <div class="text-xs font-bold text-slate-500 uppercase mb-1">Total COGS</div>
                  <div class="text-xl font-bold text-slate-800" id="cogs-total">0.00 EGP</div>
                  <div class="text-[10px] text-slate-400 font-semibold mt-1">Cost of Goods</div>
                </div>
                <div class="bg-white p-4 rounded-xl shadow-sm border border-slate-200">
                  <div class="text-xs font-bold text-slate-500 uppercase mb-1">Gross Profit</div>
                  <div class="text-xl font-bold text-emerald-700" id="cogs-profit">0.00 EGP</div>
                  <div class="text-[10px] text-emerald-600 font-semibold mt-1">Net Sales - COGS</div>
                </div>
                <div class="bg-white p-4 rounded-xl shadow-sm border border-slate-200">
                  <div class="text-xs font-bold text-slate-500 uppercase mb-1">Profit Margin %</div>
                  <div class="text-xl font-bold text-blue-600" id="cogs-margin">0.0%</div>
                  <div class="text-[10px] text-blue-400 font-semibold mt-1">Profit / Net Sales</div>
                </div>
                <div class="bg-white p-4 rounded-xl shadow-sm border border-slate-200">
                  <div class="text-xs font-bold text-slate-500 uppercase mb-1">Avg Cost / Order</div>
                  <div class="text-xl font-bold text-slate-800" id="cogs-avg-cost">0.00 EGP</div>
                  <div class="text-[10px] text-slate-400 font-semibold mt-1">Efficiency Metric</div>
                </div>
              </div>

              <!-- Row 2: Charts -->
              <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                <!-- Profit Breakdown -->
                <div class="lg:col-span-2 bg-white p-5 rounded-xl shadow-sm border border-slate-200">
                  <h3 class="font-bold text-slate-800 mb-4 flex items-center gap-2">
                    <span class="material-symbols-outlined text-emerald-600">bar_chart</span> Income Breakdown
                  </h3>
                  <div class="h-64 relative">
                    <canvas id="chart-cogs-breakdown"></canvas>
                  </div>
                </div>
                <!-- COGS by Category -->
                <div class="bg-white p-5 rounded-xl shadow-sm border border-slate-200">
                  <h3 class="font-bold text-slate-800 mb-4 flex items-center gap-2">
                    <span class="material-symbols-outlined text-amber-600">pie_chart</span> Cost by Category
                  </h3>
                  <div class="h-64 relative flex items-center justify-center">
                    <canvas id="chart-cogs-category"></canvas>
                  </div>
                </div>
              </div>

              <!-- Row 3: Tables -->
              <div class="grid grid-cols-1 xl:grid-cols-2 gap-6">

                <!-- Product Profitability -->
                <div class="bg-white rounded-xl shadow-sm border border-slate-200 overflow-hidden">
                  <div class="px-6 py-4 border-b border-slate-100 font-bold text-slate-800 flex items-center gap-2">
                    <span class="material-symbols-outlined text-slate-400">inventory_2</span> Product Profitability
                  </div>
                  <div class="overflow-x-auto max-h-80">
                    <table id="table-cogs-products-export" class="w-full text-left border-collapse">
                      <thead
                        class="bg-slate-50 text-xs font-semibold text-slate-500 uppercase border-b border-slate-200 sticky top-0">
                        <tr>
                          <th class="px-4 py-2">Product</th>
                          <th class="px-4 py-2">Sold</th>
                          <th class="px-4 py-2">Cost</th>
                          <th class="px-4 py-2">Profit</th>
                          <th class="px-4 py-2">Margin</th>
                        </tr>
                      </thead>
                      <tbody id="table-cogs-products" class="divide-y divide-slate-100 text-sm text-slate-600"></tbody>
                    </table>
                  </div>
                </div>

                <!-- Category Profitability -->
                <div class="bg-white rounded-xl shadow-sm border border-slate-200 overflow-hidden">
                  <div class="px-6 py-4 border-b border-slate-100 font-bold text-slate-800 flex items-center gap-2">
                    <span class="material-symbols-outlined text-slate-400">category</span> Category Profitability
                  </div>
                  <div class="overflow-x-auto max-h-80">
                    <table class="w-full text-left border-collapse">
                      <thead
                        class="bg-slate-50 text-xs font-semibold text-slate-500 uppercase border-b border-slate-200 sticky top-0">
                        <tr>
                          <th class="px-4 py-2">Category</th>
                          <th class="px-4 py-2">Cost</th>
                          <th class="px-4 py-2">Revenue</th>
                          <th class="px-4 py-2">Profit</th>
                          <th class="px-4 py-2">Margin</th>
                        </tr>
                      </thead>
                      <tbody id="table-cogs-categories" class="divide-y divide-slate-100 text-sm text-slate-600">
                      </tbody>
                    </table>
                  </div>
                </div>

                <!-- Low Margin Alerts (Full Width) -->
                <div class="xl:col-span-2 bg-white rounded-xl shadow-sm border border-slate-200 overflow-hidden">
                  <div class="px-6 py-4 border-b border-slate-100 font-bold text-slate-800 flex items-center gap-2">
                    <span class="material-symbols-outlined text-red-500">warning</span> Low Margin Alerts (&lt; 20%)
                  </div>
                  <div class="overflow-x-auto max-h-80">
                    <table class="w-full text-left border-collapse">
                      <thead
                        class="bg-slate-50 text-xs font-semibold text-slate-500 uppercase border-b border-slate-200 sticky top-0">
                        <tr>
                          <th class="px-6 py-3">Product Name</th>
                          <th class="px-6 py-3">Current Cost</th>
                          <th class="px-6 py-3">Sales Price</th>
                          <th class="px-6 py-3">Margin %</th>
                          <th class="px-6 py-3">Suggested Price (30%)</th>
                        </tr>
                      </thead>
                      <tbody id="table-cogs-alerts" class="divide-y divide-slate-100 text-sm text-slate-600"></tbody>
                    </table>
                  </div>
                </div>

              </div>
            </div>

            <!-- 6. STOCK VALUE (Admin) -->
            <!-- 6. STOCK VALUE (Admin) -->
            <div id="card-inventory-report" class="report-card admin-only hidden space-y-6">
              <!-- KPI Row -->
              <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
                <div class="bg-white p-4 rounded-xl shadow-sm border border-slate-200">
                  <p class="text-xs text-slate-500 font-bold uppercase">Total Stock Cost</p>
                  <h3 class="text-2xl font-bold text-slate-800" id="inv-stock-cost">0.00</h3>
                </div>
                <div class="bg-white p-4 rounded-xl shadow-sm border border-slate-200">
                  <p class="text-xs text-slate-500 font-bold uppercase">Retail Value</p>
                  <h3 class="text-2xl font-bold text-blue-600" id="inv-retail-value">0.00</h3>
                </div>
                <div class="bg-white p-4 rounded-xl shadow-sm border border-slate-200">
                  <p class="text-xs text-slate-500 font-bold uppercase">Expected Profit</p>
                  <h3 class="text-2xl font-bold text-green-600" id="inv-expected-profit">0.00</h3>
                </div>
                <div class="bg-white p-4 rounded-xl shadow-sm border border-slate-200">
                  <p class="text-xs text-slate-500 font-bold uppercase">Low Stock Items</p>
                  <h3 class="text-2xl font-bold text-red-600" id="inv-low-stock">0</h3>
                </div>
              </div>

              <!-- Charts & Aging -->
              <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                <!-- Stock Composition -->
                <div class="bg-white p-5 rounded-xl shadow-sm border border-slate-200">
                  <h3 class="font-bold text-slate-800 mb-4">Stock by Category</h3>
                  <div class="h-64 relative flex items-center justify-center">
                    <canvas id="chart-inv-category"></canvas>
                  </div>
                </div>

                <!-- Top Assets -->
                <div class="lg:col-span-2 bg-white p-5 rounded-xl shadow-sm border border-slate-200">
                  <h3 class="font-bold text-slate-800 mb-4">Top 10 High Value Assets</h3>
                  <div class="h-64">
                    <canvas id="chart-inv-top-assets"></canvas>
                  </div>
                </div>
              </div>

              <!-- Aging Analysis -->
              <div class="bg-white p-6 rounded-xl shadow-sm border border-slate-200">
                <h3 class="font-bold text-lg text-slate-800 mb-4">Inventory Aging Analysis</h3>
                <div class="grid grid-cols-2 lg:grid-cols-4 gap-4 mb-6">
                  <div class="p-4 bg-green-50 rounded-lg text-center">
                    <div class="text-2xl font-bold text-green-700" id="aging-0-7">0</div>
                    <div class="text-xs font-bold text-green-600 uppercase">Healthy (0-7 Days)</div>
                  </div>
                  <div class="p-4 bg-blue-50 rounded-lg text-center">
                    <div class="text-2xl font-bold text-blue-700" id="aging-8-30">0</div>
                    <div class="text-xs font-bold text-blue-600 uppercase">Warning (8-30 Days)</div>
                  </div>
                  <div class="p-4 bg-amber-50 rounded-lg text-center">
                    <div class="text-2xl font-bold text-amber-700" id="aging-31-90">0</div>
                    <div class="text-xs font-bold text-amber-600 uppercase">Slow (31-90 Days)</div>
                  </div>
                  <div class="p-4 bg-red-50 rounded-lg text-center">
                    <div class="text-2xl font-bold text-red-700" id="aging-90">0</div>
                    <div class="text-xs font-bold text-red-600 uppercase">Dead Stock (90+ Days)</div>
                  </div>
                </div>

                <div class="overflow-x-auto max-h-96">
                  <table id="table-inventory-export" class="w-full text-left border-collapse">
                    <thead
                      class="bg-slate-50 text-xs font-semibold text-slate-500 uppercase border-b border-slate-200 sticky top-0">
                      <tr>
                        <th class="px-6 py-3">Product</th>
                        <th class="px-6 py-3">Category</th>
                        <th class="px-6 py-3">Qty</th>
                        <th class="px-6 py-3">Unit Cost</th>
                        <th class="px-6 py-3">Total Value</th>
                        <th class="px-6 py-3">Last Sold</th>
                        <th class="px-6 py-3">Days Idle</th>
                        <th class="px-6 py-3">Health</th>
                      </tr>
                    </thead>
                    <tbody id="table-inventory-health" class="divide-y divide-slate-100 text-sm text-slate-600"></tbody>
                  </table>
                </div>
              </div>
            </div>

          </div>
    </main>
  </div>

  <!-- Footer -->
  <footer
    class="fixed bottom-0 right-0 p-2 text-xs text-slate-400 bg-white/80 backdrop-blur-sm rounded-tl-lg hidden sm:block">
    Tashgheel POS v2.0
  </footer>

  <!-- Scripts -->
  <script src="js/web-adapter.js?v=2.4"></script>
  <script src="js/auth.js?v=2.4"></script>
  <script src="js/db.js?v=2.4"></script>
  <script>window.currentPage = 'reports';</script>
  <script src="js/shared-nav.js?v=2.4"></script>
  <script src="js/translations.js?v=2.4"></script>
  <!-- EXTERNAL LIBS -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/xlsx/dist/xlsx.full.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>

  <!-- MODULES -->
  <script src="js/reports-engine.js?v=2.4"></script>
  <script src="js/reports-charts.js?v=2.4"></script>
  <script src="js/reports-export.js?v=2.4"></script>
  <script src="js/reports-app.js?v=2.4"></script>

</body>

</html>